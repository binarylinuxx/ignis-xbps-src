#!/usr/bin/fish

# Colors for output
set -l GREEN '\033[0;32m'
set -l RED '\033[0;31m'
set -l YELLOW '\033[1;33m'
set -l NC '\033[0m' # No Color

echo -e $YELLOW"[INFO] Starting repository update and signing process..."$NC

# Check if we have any .xbps files
if not test -f pkgs/*.xbps
    echo -e $RED"[ERROR] No .xbps files found in pkgs/ directory"$NC
    exit 1
end

# Check XBPS version
echo -e $YELLOW"[INFO] XBPS version:"$NC
xbps-rindex --version

# Check if private key exists, create if it doesn't
if not test -f privkey.pem
    echo -e $YELLOW"[INFO] Private key not found, generating new one..."$NC
    openssl genrsa -out privkey.pem 4096
    chmod 600 privkey.pem
    echo -e $GREEN"[SUCCESS] Private key generated: privkey.pem"$NC
else
    echo -e $GREEN"[INFO] Using existing private key: privkey.pem"$NC
    # Verify key is valid
    if not openssl rsa -in privkey.pem -check -noout
        echo -e $RED"[ERROR] Private key is invalid"$NC
        exit 1
    end
end

# Clean and rebuild repository index
echo -e $YELLOW"[INFO] Cleaning old repository data..."$NC
rm -f pkgs/x86_64-repodata

echo -e $YELLOW"[INFO] Building repository index..."$NC
if xbps-rindex -v -a pkgs/*.xbps
    echo -e $GREEN"[SUCCESS] Repository index created"$NC
else
    echo -e $RED"[ERROR] Failed to create repository index"$NC
    exit 1
end

# Try signing individual packages first
echo -e $YELLOW"[INFO] Signing individual packages..."$NC
for pkg in pkgs/*.xbps
    echo -e $YELLOW"[INFO] Signing: $pkg"$NC
    if xbps-rindex -d -v --sign-pkg --signedby 'binarylinuxx <aar58384@gmail.com>' --privkey privkey.pem $pkg
        echo -e $GREEN"[SUCCESS] Package signed: $pkg"$NC
    else
        echo -e $RED"[ERROR] Failed to sign package: $pkg"$NC
    end
end

# Sign the repository metadata
echo -e $YELLOW"[INFO] Signing repository metadata..."$NC
if xbps-rindex -d -v --sign --signedby 'binarylinuxx <aar58384@gmail.com>' --privkey privkey.pem pkgs/
    echo -e $GREEN"[SUCCESS] Repository metadata signed"$NC
else
    echo -e $RED"[ERROR] Failed to sign repository metadata"$NC
    exit 1
end

# Check what files were created (Fish-safe way)
echo -e $YELLOW"[INFO] Checking created files..."$NC
set -l sig_files (find pkgs/ -name "*.sig2" 2>/dev/null | wc -l)
set -l xbps_files (find pkgs/ -name "*.xbps" | wc -l)

echo -e $YELLOW"[INFO] Found $sig_files signature files and $xbps_files package files"$NC

if test $sig_files -gt 0
    echo -e $GREEN"[SUCCESS] Signature files created:"$NC
    find pkgs/ -name "*.sig2" -exec basename {} \;
else
    echo -e $RED"[WARNING] No signature files found"$NC
end

# Show repository contents
echo -e $YELLOW"[INFO] Repository contents:"$NC
ls -la pkgs/

# Verify repository can be read
echo -e $YELLOW"[INFO] Testing repository..."$NC
if xbps-query --repository=pkgs/ -L >/dev/null 2>&1
    echo -e $GREEN"[SUCCESS] Repository is readable"$NC
else
    echo -e $YELLOW"[WARNING] Repository test failed - this might be normal if no signatures exist"$NC
end

echo -e $GREEN"[INFO] Process complete!"$NC
echo -e $YELLOW"[NEXT] If signatures were created, commit and push:"$NC
echo "  git add pkgs/"
echo "  git commit -m 'Update repository with signatures'"
echo "  git push"
